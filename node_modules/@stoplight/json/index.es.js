import{cloneDeep as e,get as t,set as r,has as n,setWith as o,omit as i,trimStart as a}from"lodash";import{isAbsolute as s,join as c,dirname as u}from"@stoplight/path";import{createScanner as l,findNodeAtOffset as f,getNodePath as p,visit as h,printParseErrorCode as y}from"jsonc-parser";import g,{getOrder as d,ORDER_KEY_ID as v}from"@stoplight/ordered-object-literal";import{DiagnosticSeverity as m}from"@stoplight/types";import b from"safe-stable-stringify";function w(e){if("object"!=typeof e||null===e)return!1;const t=Object.getPrototypeOf(e);return null===t||t===Object.prototype||"function"==typeof e.constructor&&Function.toString.call(Object)===Function.toString.call(e.constructor)}function O(e,t,r){if(!w(e)&&!Array.isArray(e)||!(t in e))throw new ReferenceError(`Could not resolve '${r}'`)}function j(e){if("string"!=typeof e.$ref)throw new TypeError("$ref should be a string")}const A=e=>w(e)&&"$ref"in e,$=e=>A(e)&&"string"==typeof e.$ref,E=e=>e.length>0&&("#"===e||/^#\S*$/.test(e)),S=(e,t,r)=>{const n=e.toString();let o="",i=n,a=0,s=i.indexOf(t);for(;s>-1;)o+=n.substring(a,a+s)+r,i=i.substring(s+t.length,i.length),a+=s+t.length,s=i.indexOf(t);return i.length>0&&(o+=n.substring(n.length-i.length,n.length)),o},x=e=>"number"==typeof e?e:S(S(e,"~","~0"),"/","~1"),N=e=>_(e),_=e=>{if(e&&"object"!=typeof e)throw new TypeError("Invalid type: path must be an array of segments.");return 0===e.length?"#":`#/${e.map(x).join("/")}`};function k(e){try{return decodeURIComponent(e)}catch(t){return e}}const P=/%[0-9a-f]+/gi,T=e=>{let t;try{t=decodeURIComponent(e)}catch(r){t=e.replace(P,k)}return S(S(t,"~1","/"),"~0","~")},I=e=>R(e),R=e=>{if("string"!=typeof e)throw new TypeError("Invalid type: JSON Pointers are represented as strings.");if(0===e.length||"#"!==e[0])throw new URIError("Invalid JSON Pointer syntax; URI fragment identifiers must begin with a hash.");if(1===e.length)return[];if("/"!==e[1])throw new URIError("Invalid JSON Pointer syntax.");return(e=>{const t=e.length,r=[];let n=-1;for(;++n<t;)r.push(T(e[n]));return r})(e.substring(2).split("/"))},K=(e,t,r)=>{const n={value:e,path:r};t.onEnter&&t.onEnter(n);for(const n of Object.keys(e)){const o=e[n];t.onProperty&&t.onProperty({parent:e,parentPath:r,property:n,propertyValue:o}),"object"==typeof o&&null!==o&&K(o,t,r.concat(n))}t.onLeave&&t.onLeave(n)},J=(e,t)=>{"object"==typeof e&&null!==e&&K(e,"function"==typeof t?{onProperty:t}:t,[])};function U(e,t,r){J(e,{onProperty({property:e,propertyValue:n,parent:o}){"$ref"===e&&"string"==typeof n&&n.startsWith(t)&&(o.$ref=`${r}${n.slice(t.length)}`)}})}const M=e=>{if("string"!=typeof e||0===e.length||E(e))return null;const t=e.indexOf("#");return-1===t?e:e.slice(0,t)};function C(e,t){return w(t)&&w(e)&&("summary"in e||"description"in e)?Object.assign(Object.assign(Object.assign({},t),"description"in e?{description:e.description}:null),"summary"in e?{summary:e.summary}:null):t}function*V(e,t,r){A(e.value)&&(j(e.value),yield[-1,e.value]);for(const[n,o]of t.entries())O(e.value,o,r),e.value=e.value[o],A(e.value)&&(j(e.value),yield[n,e.value])}function D(e,t){return W(e,t).value}function W(e,t){return function e(t,r,n,o){if(null!==M(r))throw new ReferenceError("Cannot resolve external references");const i=I(r);let a=[...i];"#"===r&&A(t)&&(j(t),i.unshift(...I(t.$ref)));const s={value:t};for(const[c,u]of V(s,i,r)){if(n.includes(u))return{source:null,location:null!=o?o:a,value:n[n.length-1]};n.push(u);const r=e(t,u.$ref,n,a);s.value=r.value,(a=r.location).push(...i.slice(c+1))}return{source:null,location:a,value:n.length>0?C(n[n.length-1],s.value):s.value}}(e,t,[])}const F="#/__bundled__",L="#/__errors__",B=({document:t,path:r,bundleRoot:n="#/__bundled__",errorsRoot:o="#/__errors__",cloneDocument:i=!0,keyProvider:a},s)=>{if(r===n||r===o)throw new Error("Roots do not make any sense");const c=i?e(t):t;return q(c,I(n),I(o),r,a)(r,{[r]:!0},s)},q=(e,a,s,c,u)=>{const l=new Set,f=(p,h,y,g={},d={},v={})=>{const m=I(p),b=t(e,m);J(y||b,{onEnter:({value:s})=>{if($(s)&&E(s.$ref)){const y=s.$ref;if(v[y])return;if(y===p&&(g[y]="#"),g[y])return void(s.$ref=g[y]);let m,b,w,O,j;try{let r;m=I(y),u&&(r=u({document:e,path:m})),r||(r=(({document:e,path:r})=>{if(0===r.length)return"root";if(Array.isArray(t(e,r.slice(0,-1))))return`${r[r.length-2]}_${r[r.length-1]}`;return String(r[r.length-1])})({document:e,path:m})),w=r;let n=1;for(;l.has(w);)if(w=`${r}_${++n}`,n>20)throw new Error(`Keys ${r}_2 through ${r}_20 already taken.`);l.add(w),b=[...a,w],O=N(b)}catch(e){v[y]=e instanceof Error?e.message:String(e)}if(!m||!b||!O)return;if("object"==typeof e&&null!==e&&!(j=t(e,m)))try{j=D(Object(e),y)}catch(e){}void 0!==j&&(g[y]=O,s.$ref=O,n(d,b)||(Array.isArray(j)?r(d,b,new Array(j.length).fill(null)):"object"==typeof j&&o(d,b,{},Object),r(d,b,j),"#"===y?function(e,t,n,o){const a=n.map(e=>`[${JSON.stringify(e)}]`).join(""),s=JSON.parse(JSON.stringify(i(Object(e),a))),c={};r(t,o,s),r(s,n,c),U(s,"#",N(o)),c.$ref="#"}(e,d,I(c),b):h[y]||(h[y]=!0,f(p,h,j,g,d,v),h[y]=!1)))}}});const w=t(d,a);return w&&Object.keys(w).length&&r(b,a,w),(Object.keys(v).length||n(e,s))&&r(b,s,n(e,s)?t(e,s):v),b};return f};const z=e=>S(S(e,"~1","/"),"~0","~"),G=(e,t)=>{const r=new WeakMap;return function e(n,o){let i;if(t&&(n=t(n)),w(n)||Array.isArray(n)){const t=r.get(n);return t?{$ref:t}:(r.set(n,N(o)),Array.isArray(n)?i=n.map((t,r)=>e(t,[...o,String(r)])):(i={},Object.keys(n).forEach(t=>{i[t]=e(n[t],[...o,t])})),r.delete(n),i)}return n}(e,[])},H=e=>S(S(e,"~","~0"),"//","/~1"),Q=e=>{if("string"!=typeof e||0===e.length)return null;const t=e.indexOf("#");return-1===t?null:e.slice(t)},X=e=>{const t=l(e,!0);if(t.scan(),1!==t.getToken())return;if(t.scan(),2===t.getToken())return;if(10!==t.getToken())throw new SyntaxError("Unexpected character");const r=t.getTokenValue();if(t.scan(),6!==t.getToken())throw new SyntaxError("Colon expected");switch(t.scan(),t.getToken()){case 10:return[r,t.getTokenValue()];case 11:return[r,Number(t.getTokenValue())];case 8:return[r,!0];case 9:return[r,!1];case 7:return[r,null];case 16:throw new SyntaxError("Unexpected character");case 17:throw new SyntaxError("Unexpected end of file");default:return}},Y=({lineMap:e,ast:t},r)=>{const n=e[r.line],o=e[r.line+1];if(void 0===n)return;const i=f(t,void 0===o?n+r.character:Math.min(o,n+r.character),!0);if(void 0===i)return;const a=p(i);return 0!==a.length?a:void 0};function Z(e){return z(e.split("/").pop()||"")}const ee=({ast:e},t,r=!1)=>{const n=function(e,t,r){e:for(const n of t){const t=Number.isInteger(Number(n))?Number(n):n;if("string"==typeof t||"number"==typeof t&&"array"!==e.type){if("object"!==e.type||!Array.isArray(e.children))return r?e:void 0;for(const r of e.children)if(Array.isArray(r.children)&&r.children[0].value===String(t)&&2===r.children.length){e=r.children[1];continue e}return r?e:void 0}if("array"!==e.type||t<0||!Array.isArray(e.children)||t>=e.children.length)return r?e:void 0;e=e.children[t]}return e}(e,t,r);if(void 0!==n&&void 0!==n.range)return{range:n.range}};const te=(e,t={disallowComments:!0})=>{const r=[],{ast:n,data:o,lineMap:i}=re(e,r,t);return{data:o,diagnostics:r,ast:n,lineMap:i}};function re(e,t=[],r){const n=oe(e);let o={type:"array",offset:-1,length:-1,children:[],parent:void 0},i=null,a=[];const s=new WeakMap,c=[];function u(e){"property"===o.type&&(o.length=e-o.offset,o=o.parent)}function l(e,t,r){return{start:{line:e,character:t},end:{line:e,character:t+r}}}function f(e){return o.children.push(e),e}function p(e){Array.isArray(a)?a.push(e):null!==i&&(a[i]=e)}function v(e){p(e),c.push(a),a=e,i=null}function b(){a=c.pop()}h(e,{onObjectBegin:(e,t,n,i)=>{o=f({type:"object",offset:e,length:-1,parent:o,children:[],range:l(n,i,t)}),!1===r.ignoreDuplicateKeys&&s.set(o,[]),v(function(e){return e?g({}):{}}(!0===r.preserveKeyOrder))},onObjectProperty:(e,n,c,u,p)=>{if((o=f({type:"property",offset:n,length:-1,parent:o,children:[]})).children.push({type:"string",value:e,offset:n,length:c,parent:o}),!1===r.ignoreDuplicateKeys){const r=s.get(o.parent);r&&(0!==r.length&&r.includes(e)?t.push({range:l(u,p,c),message:"DuplicateKey",severity:m.Error,path:ie(o),code:20}):r.push(e))}!0===r.preserveKeyOrder&&function(e,t){if(!(t in e))return;const r=d(e),n=r.indexOf(t);-1!==n&&(r.splice(n,1),r.push(t))}(a,e),i=e},onObjectEnd:(e,t,n,i)=>{!1===r.ignoreDuplicateKeys&&s.delete(o),o.length=e+t-o.offset,o.range&&(o.range.end.line=n,o.range.end.character=i+t),o=o.parent,u(e+t),b()},onArrayBegin:(e,t,r,n)=>{o=f({type:"array",offset:e,length:-1,parent:o,children:[],range:l(r,n,t)}),v([])},onArrayEnd:(e,t,r,n)=>{o.length=e+t-o.offset,o.range&&(o.range.end.line=r,o.range.end.character=n+t),o=o.parent,u(e+t),b()},onLiteralValue:(e,t,r,n,i)=>{f({type:ne(e),offset:t,length:r,parent:o,value:e,range:l(n,i,r)}),u(t+r),p(e)},onSeparator:(e,t)=>{"property"===o.type&&(":"===e?o.colonOffset=t:","===e&&u(t))},onError:(e,r,n,o,i)=>{t.push({range:l(o,i,n),message:y(e),severity:m.Error,code:e})}},r);const w=o.children[0];return w&&delete w.parent,{ast:w,data:a[0],lineMap:n}}function ne(e){switch(typeof e){case"boolean":return"boolean";case"number":return"number";case"string":return"string";default:return"null"}}const oe=e=>{const t=[0];let r=0;for(;r<e.length;r++)"\n"===e[r]&&t.push(r+1);return t.push(r+1),t};function ie(e,t=[]){return"property"===e.type&&t.unshift(e.children[0].value),void 0!==e.parent?("array"===e.parent.type&&void 0!==e.parent.parent&&t.unshift(e.parent.children.indexOf(e)),ie(e.parent,t)):t}const ae=(e,t,r)=>{if(!e||!Object.hasOwnProperty.call(e,t)||t===r)return e;const n={};for(const[o,i]of Object.entries(e))o===t?n[r]=i:o in n||(n[o]=i);return n};function se(e){return w(e)||Array.isArray(e)}function ce(e,t,r){if(r.length<=1||t.length<=1)throw Error("Source/target path must not be empty and point at root");if(0===t.indexOf(r))throw Error("Target path cannot be contained within source");const n=I(t);let o=e;for(const e of n){if(!se(o))return;o=o[e]}if(!se(o))return;const i=I(r);let a=e;for(const[e,t]of i.entries()){if(!se(a)||t in a)return;const r=e===i.length-1?o:{};a[t]=r,a=r}delete e[n[0]],function e(t,r,n){for(const o of Object.keys(t)){const i=t[o];if("$ref"!==o)se(i)&&e(i,r,n);else{if("string"!=typeof i||!E(i))continue;0===i.indexOf(r)&&(t[o]=i.replace(r,n))}}}(e,t,r)}async function ue(e,t,r,n,o){let i=function(e,t){const r=M(t);return null===r?e:s(r)?r:c(u(e),r)}(t,r);const a=Q(r)||"#",l=await e[i],f=I(a);let p=[...f];const h={value:l};for(const[r,s]of V(h,f,a)){if(n.includes(s))return{source:t,location:null!=o?o:p,value:n[n.length-1]};n.push(s);const a=await ue(e,i,s.$ref,n,p);({source:i,location:p}=a),h.value=a.value,p.push(...f.slice(r+1))}return{source:i,location:p,value:n.length>0?C(n[n.length-1],h.value):h.value}}async function le(e,t,r){return(await fe(e,t,r)).value}function fe(e,t,r){return ue(e,t,r,[])}const pe=(e,t)=>{if("string"!=typeof e)return e;try{const r=he(e);return"string"==typeof r?r:JSON.parse(e,t)}catch(e){return}},he=e=>{const t=Number(e);return Number.isFinite(t)?String(t)===e?t:e:NaN},ye=(e,t,r)=>{if("string"==typeof e)return e;try{return JSON.stringify(e,t,r)}catch(n){return b(e,t,r)}},ge=(e,t)=>{if(e instanceof Array){if(t instanceof Array){if(t.length>e.length)return!1;for(const r in t){if(!t.hasOwnProperty(r))continue;const n=parseInt(e[r]),o=parseInt(t[r]);if(isNaN(n)&&isNaN(o)){if(e[r]!==t[r])return!1}else if(n!==o)return!1}}}else{if("string"!=typeof e)return!1;if("string"==typeof t)return e.startsWith(t)}return!0},de=(e,t,r)=>{const n=ye(e,t,r);if(void 0===n)throw new Error("The value could not be stringified");return n};function ve(e){return e.replace(/^(\/|#\/)/,"").split("/").map(z).map(me).join(".")}function me(e){return e.includes(".")?`["${e.replace(/"/g,'\\"')}"]`:e}const be=Symbol.for(v),we={ownKeys:e=>be in e?e[be]:Reflect.ownKeys(e)},Oe=e=>new Proxy(e,we);function je(e,t){if("string"==typeof e&&"string"==typeof t)return a(e,t);if(!(e&&Array.isArray(e)&&e.length&&t&&Array.isArray(t)&&t.length))return e;let r=0;for(const n in e)if(e.hasOwnProperty(n)){if(e[n]!==t[n])break;r++}return e.slice(r)}export{F as BUNDLE_ROOT,L as ERRORS_ROOT,be as KEYS,B as bundleTarget,T as decodePointer,z as decodePointerFragment,G as decycle,H as encodePointer,x as encodePointerFragment,Q as extractPointerFromRef,M as extractSourceFromRef,X as getFirstPrimitiveProperty,Y as getJsonPathForPosition,Z as getLastPathSegment,ee as getLocationForJsonPath,$ as hasRef,E as isLocalRef,w as isPlainObject,re as parseTree,te as parseWithPointers,N as pathToPointer,I as pointerToPath,U as remapRefs,ae as renameObjectKey,ce as reparentBundleTarget,le as resolveExternalRef,fe as resolveExternalRefWithLocation,D as resolveInlineRef,W as resolveInlineRefWithLocation,pe as safeParse,ye as safeStringify,ge as startsWith,de as stringify,ve as toPropertyPath,Oe as trapAccess,J as traverse,je as trimStart};
